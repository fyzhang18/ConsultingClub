---
title: "Chronic Absenteeism - District Level Comparisons"
author: "Felicia Zhang"
date: '2018-06-03'
output: pdf_document
toc: yes
toc_depth: 2
fontsize: 12pt
fig_height: 5
fig_width: 7
---

```{r setup, include=FALSE, warning=FALSE}
library(ggplot2) 
library(zoo)
library(reshape)
library(plyr)
library(dplyr)
library(scales) 
library(data.table)
library(signal)
library(matrixStats)
library(lme4)
library(arm)
library(broom)
library(tidyr)
library(wesanderson)
library(readxl)    
library(extrafont)

#LOAD MULTIPLE EXCEL SHEETS INTO SEPARATE DFS

#get names of sheets
sheets <- readxl::excel_sheets("~/Documents/Felicia Zhang/Felicia/Princeton/ConsultingClub/PerformanceReportsSchoolData_SY1617_FZ.xlsx")

#load in excel data as 1 big file
lst <- lapply(sheets, function(sheet) 
  readxl::read_excel("~/Documents/Felicia Zhang/Felicia/Princeton/ConsultingClub/PerformanceReportsSchoolData_SY1617_FZ.xlsx", sheet = sheet)
)

#prepare names
names(lst) <- sheets

#turn it into DF
list2env(lst, envir = .GlobalEnv)
```

```{r, echo=FALSE, warning=FALSE, include=FALSE}
###Create Chronic Absenteeism percent for each grade, each school, and each district

#*SchoolPercent is n of students absent/n of students in the grade NOT n of students absent/n of students in the school -_-

poo <- EnrollmentTrendsByGrade

#remove ungraded and Total Enrollment
poo <- poo[!(poo$Grade=="Ungraded"),]
poo <- poo[!(poo$Grade=="Total Enrollment"),]

#remove the word Grade from beginning
poo$Grade <- substring(poo$Grade, 7)

#reformat poo Grade (it's written as 07 instead of 7)
poo$Grade[poo$Grade=="01"] <- "1"
poo$Grade[poo$Grade=="02"] <- "2"
poo$Grade[poo$Grade=="03"] <- "3"
poo$Grade[poo$Grade=="04"] <- "4"
poo$Grade[poo$Grade=="05"] <- "5"
poo$Grade[poo$Grade=="06"] <- "6"
poo$Grade[poo$Grade=="07"] <- "7"
poo$Grade[poo$Grade=="08"] <- "8"
poo$Grade[poo$Grade=="09"] <- "9"

poo2 <- ChronicAbsByGrade

#combine the 2
AbsentGrade <- merge(poo, poo2, by=c("CountyCode","DistrictCode","SchoolCode","Grade")) # NA's match

#relabel SchoolPercent to GradePercent
names(AbsentGrade)[5]<-"NumofStudents"
names(AbsentGrade)[6]<-"GradePercent"

#replace grades with numeric
AbsentGrade$Grade[AbsentGrade$Grade=="PK"] <- "-1"
AbsentGrade$Grade[AbsentGrade$Grade=="KG"] <- "0"

#label missing values as NA
AbsentGrade[AbsentGrade == "N"] <- NA
AbsentGrade[AbsentGrade == "*"] <- NA

#convert all columns to numeric
AbsentGrade[] <- lapply(AbsentGrade, function(x) as.numeric(as.character(x)))

#convert GradePercent to decimal
AbsentGrade$GradePercent <- AbsentGrade$GradePercent/100

#calculate Number of students absent using total number of students * percent absent
AbsentGrade$NumStudentsAbsent <- AbsentGrade$NumofStudents * AbsentGrade$GradePercent
AbsentGrade$NumStudentsAbsent <- round(AbsentGrade$NumStudentsAbsent)

#get percent absent for each school
AbsentSchool <- group_by(AbsentGrade,CountyCode,DistrictCode,SchoolCode) %>%
  summarise(
    percentabsent = sum(NumStudentsAbsent) / sum(NumofStudents)
  )

#get percent absent for each district
AbsentDistrict <- group_by(AbsentGrade,CountyCode,DistrictCode) %>%
  summarise(
    percentabsent = sum(NumStudentsAbsent) / sum(NumofStudents)
  )

#Mercer county = 21

```

### Distribution of chronic absenteeism rate in NJ

```{r, echo=FALSE, warning=FALSE,message=FALSE,fig.width=7, fig.height=8}
#histogram of school absenteeism rate 
#to see min, max, whatâ€™s the most common rate

poo <- na.omit(AbsentSchool)

#color mercer county differently
poo$color <- 0
poo$color[poo$CountyCode==21] <- 1

ggplot(poo, aes(percentabsent, fill=factor(color)))+
  geom_histogram(binwidth = 0.01)+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Chronic absenteeism rate", y = "Number of schools")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_x_continuous(labels=percent,limits=c(-0.1,1),breaks=seq(-0.1,1,.1))+
  theme(legend.position = "bottom")+
  scale_fill_manual(values = c("#CCCCCC", "#FF6633"),name="County",breaks=c("0","1"),labels=c("Others", "Mercer"))+
  theme(text=element_text(family="Times"))
```

### Distribution of chronic absenteeism rate in Mercer County

```{r, echo=FALSE, warning=FALSE,message=FALSE,fig.width=7, fig.height=8}
poo <- na.omit(AbsentSchool)

#only mercer county
poo2 <- subset(poo, CountyCode==21)

ggplot(poo2, aes(percentabsent, fill=factor(DistrictCode)))+
  geom_histogram(binwidth = 0.01)+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Chronic absenteeism rate", y = "Number of schools")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_x_continuous(labels=percent,limits=c(-0.1,1),breaks=seq(-0.1,1,.1))+
  scale_y_continuous(limits=c(0,11),breaks=seq(0,11,1))+
  theme(legend.position = "bottom")+
  scale_fill_brewer(palette="Set3",name="District")+
  theme(text=element_text(family="Times"))
```

### Distribution of chronic absenteeism rate in Mercer County by Grade

```{r, echo=FALSE, warning=FALSE}
#Chronic absenteeism rate by grade in only mercer county
poo <- AbsentGrade

poo2 <- group_by(poo, CountyCode, DistrictCode, Grade) %>%
  summarise(
    percentabsent = mean(GradePercent)
  )

#only mercer county
poo3 <- subset(poo2, CountyCode==21)

poo.final <- group_by(poo3, Grade) %>%
  summarise(
    meanPercentabsent = mean(percentabsent,  na.rm = TRUE),
    sePercentabsent=sd(percentabsent, na.rm = TRUE)/sqrt(length(percentabsent))
  )

limits <- aes(ymax = meanPercentabsent + sePercentabsent, ymin=meanPercentabsent - sePercentabsent)

ggplot(poo.final,aes(x=factor(Grade),y=meanPercentabsent,color=factor(Grade),fill=factor(Grade)))+
  geom_bar(stat="identity")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Grade", y = "Chronic absenteeism rate")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels=percent,limits=c(0,.5),breaks=seq(0,.5,.05))+  
  scale_x_discrete(breaks=c("-1","0","1","2","3","4","5","6","7","8","9","10","11","12"),labels=c("PK", "KG","1","2","3","4","5","6","7","8","9","10","11","12"))+
  theme(legend.position = "none")+
  geom_errorbar(limits, width=0.25,color="black")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(text=element_text(family="Times"))
```
\newpage

##Focusing on the good schools in Mercer County, which districts are they in?
Good school is defined as a school with chronic absenteeism rate of 10% or less

```{r, echo=FALSE, warning=FALSE}
#calculate mean and SD
poo <- na.omit(AbsentSchool)

#only mercer county
poo <- subset(poo, CountyCode==21)

#look at good schools: anything less than 10%
poo2 <- subset(poo, percentabsent < 0.1)

#plot
ggplot(poo2, aes(percentabsent, fill=factor(DistrictCode)))+
  geom_histogram(binwidth = 0.01)+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Chronic absenteeism rate", y = "Number of schools")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(limits=c(0,10),breaks=seq(0,10,1))+
  scale_x_continuous(labels=percent,limits=c(-0.02,.14),breaks=seq(-0.02,.14,.02))+
  theme(legend.position = "bottom")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(text=element_text(family="Times"))+
  scale_fill_brewer(palette="Set3",name="District")
```

###District 1950 (Hamilton) has the largest number of schools w low chronic absenteeism

```{r, echo=FALSE, warning=FALSE}
#plot histogram of school
poo3 <- group_by(poo2, DistrictCode) %>%
  summarise(
    count = n()
  )

#sort by descending order
poo3$DistrictCode <- factor(poo3$DistrictCode, levels = poo3$DistrictCode[order(-poo3$count)])

ggplot(poo3, aes(x=factor(DistrictCode),y=count,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "District", y = "Number of schools")+
  scale_y_continuous(limits=c(0,12),breaks=seq(0,12,2))+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "none")+
  theme(text=element_text(family="Times"))+
  scale_color_manual(values = c("#bebad9", "#bb81bc","#81b1d2","#90d3c7","#b4dc6f","#fffcb7","#f98175", "#d9d9d9","#fcb369","#fbcee5"))+
  scale_fill_manual(values = c("#bebad9", "#bb81bc","#81b1d2","#90d3c7","#b4dc6f","#fffcb7","#f98175", "#d9d9d9","#fcb369","#fbcee5"))

#best county in mercer is 1950, which has 11 schools that are good, and 5715 which has 8 schools
```

###Districts 1245 (East Windsor), 2580 (Lawrence), 3105 (Mercer County Vocational), 5510 (Robbinsville), 5715 (Windsor-Plainsboro), have all of their schools categorized as low chronic absenteeism

```{r, echo=FALSE, warning=FALSE}
poo <- na.omit(AbsentSchool)

#only mercer county
poo2 <- subset(poo, CountyCode==21)

#label low chronic absenteeism
poo2$category <- 0
poo2$category[poo2$percentabsent < 0.10001] <- 1

#plot histogram of school
poo3 <- group_by(poo2, DistrictCode) %>%
  summarise(
    percent = sum(category)/length(unique(SchoolCode))
  )

#sort by descending order
poo3$DistrictCode <- factor(poo3$DistrictCode, levels = poo3$DistrictCode[order(-poo3$percent)])

ggplot(poo3, aes(x=factor(DistrictCode),y=percent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "District", y = "Percent of schools")+
  scale_y_continuous(labels=percent)+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "none")+
  theme(text=element_text(family="Times"))+
  scale_color_manual(values = c("#90d3c7", "#81b1d2","#fcb369","#d9d9d9", "#bb81bc","#fffcb7", "#b4dc6f", "#bebad9","#f98175","#fbcee5"))+
  scale_fill_manual(values = c("#90d3c7", "#81b1d2","#fcb369","#d9d9d9", "#bb81bc","#fffcb7", "#b4dc6f", "#bebad9","#f98175","#fbcee5"))

#best county in mercer is 1950, which has 11 schools that are good, and 5715 which has 8 schools
```
\newpage

##Focus on the bad schools: which district are they in?
Bad school is defined as a school with chronic absenteeism rate of greater than 10%

```{r, echo=FALSE, warning=FALSE}
#calculate mean and SD
poo <- na.omit(AbsentSchool)

#only mercer county
poo <- subset(poo, CountyCode==21)

#look at bad schools, greater than 10%
poo2 <- subset(poo, percentabsent > 0.1)

#plot
ggplot(poo2, aes(percentabsent, fill=factor(DistrictCode)))+
  geom_histogram(binwidth = 0.01)+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Chronic absenteeism rate", y = "Number of schools")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  scale_x_continuous(labels=percent,limits=c(0,.6),breaks=seq(0,.6,.1))+
  scale_y_continuous(limits=c(0,4),breaks=seq(0,4,1))+
  theme(legend.position = "bottom")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(text=element_text(family="Times"))+
  scale_fill_brewer(palette="Accent",name="District")
```

###District 5210 (Trenton) has the largest number of schools w high chronic absenteeism

```{r, echo=FALSE, warning=FALSE}
#plot histogram of school
poo3 <- group_by(poo2, DistrictCode) %>%
  summarise(
    count = n()
  )

#sort by descending order
poo3$DistrictCode <- factor(poo3$DistrictCode, levels = poo3$DistrictCode[order(-poo3$count)])

ggplot(poo3, aes(x=factor(DistrictCode),y=count,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "District", y = "Number of schools")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(limits=c(0,20),breaks=seq(0,20,2))+
  theme(legend.position = "none")+
  theme(text=element_text(family="Times"))+
  scale_color_manual(values = c("#3b6dae", "#beafd3","#fcc08a","#fffb9f","#82c882"))+
  scale_fill_manual(values = c("#3b6dae", "#beafd3","#fcc08a","#fffb9f","#82c882"))

#worst district is 5210, which has 19 schools that are considered bad
```
\newpage

###Districts 5210 (Trenton), 2280 (Hopewell), 1950 (Hamilton), 4255 (Princeton Regional), 1430 (Ewing) have schools that are considered high chronic absenteeism. Trenton has the highest percentage with 95%. 

```{r, echo=FALSE, warning=FALSE}
poo <- na.omit(AbsentSchool)

#only mercer county
poo2 <- subset(poo, CountyCode==21)

#label high chronic absenteeism
poo2$category <- 0
poo2$category[poo2$percentabsent > 0.10] <- 1

#plot histogram of school
poo3 <- group_by(poo2, DistrictCode) %>%
  summarise(
    percent = sum(category)/length(unique(SchoolCode))
  )

poo3 <- subset(poo3, percent > 0)

#sort by descending order
poo3$DistrictCode <- factor(poo3$DistrictCode, levels = poo3$DistrictCode[order(-poo3$percent)])

ggplot(poo3, aes(x=factor(DistrictCode),y=percent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "District", y = "Percent of schools")+
  scale_y_continuous(labels=percent,limits=c(0,1),breaks=seq(0,1,.2))+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "none")+
  theme(text=element_text(family="Times"))+
  scale_color_manual(values = c("#3b6dae", "#beafd3","#fcc08a","#fffb9f","#82c882"))+
  scale_fill_manual(values = c("#3b6dae", "#beafd3","#fcc08a","#fffb9f","#82c882"))
```
\newpage

##Action plan

We know District 5210 (Trenton) has the largest number of schools (19) and highest percentage of schools (95%) with chronic absenteeism.

When we look at which districts are considered good districts it gets a bit trickier. If we look at number of schools, District 1950 (Hamilton) is first with 11 schools. But if we look at percentage of schools, District 1950 (Hamilton) is at 70%, whereas Districts 1245, 2580, 3105, 5510, 5715 are at 100%. 

\newpage
##What are the characteristics of district 1950 (good) and district 5210 (bad)?

###Number of students

```{r, echo=FALSE, warning=FALSE}
foo <- subset(EnrollmentTrendsByGrade, DistrictCode == "1950" | DistrictCode == "5210")

#remove total enrollment
foo <- foo[!(foo$Grade=="Total Enrollment"),]

#remove the word Grade from beginning
foo$Grade <- substring(foo$Grade, 7)

#reformat foo Grade (it's written as 07 instead of 7)
foo$Grade[foo$Grade=="01"] <- "1"
foo$Grade[foo$Grade=="02"] <- "2"
foo$Grade[foo$Grade=="03"] <- "3"
foo$Grade[foo$Grade=="04"] <- "4"
foo$Grade[foo$Grade=="05"] <- "5"
foo$Grade[foo$Grade=="06"] <- "6"
foo$Grade[foo$Grade=="07"] <- "7"
foo$Grade[foo$Grade=="08"] <- "8"
foo$Grade[foo$Grade=="09"] <- "9"
foo$Grade[foo$Grade=="PK"] <- "-1"
foo$Grade[foo$Grade=="KG"] <- "0"
foo$Grade[foo$Grade=="ed"] <- "99" #ungraded?

#label missing values as NA
foo[foo == "N"] <- NA
foo[foo == "*"] <- NA

#convert all columns to numeric
foo[] <- lapply(foo, function(x) as.numeric(as.character(x)))

#calculate total number of students in each grade 
foo2 <- group_by(foo, DistrictCode) %>%
  summarise(
    numofstudents = sum(Count)
  )

ggplot(foo2,aes(x=factor(DistrictCode),y=numofstudents,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "County", y = "Number of students")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "none")+
  theme(text=element_text(family="Times"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  scale_y_continuous(labels = comma, limits=c(0,15000),breaks=seq(0,15000,3000))+
  geom_text(
    aes(label = numofstudents, numofstudents = numofstudents + 0.05),
    position = position_dodge(0.9),
    vjust = -0.5
  )

```

The two districts have roughly the same number of students.
\newpage

###Grade breakdown 

```{r, echo=FALSE, warning=FALSE,fig.width=8}
foo <- subset(EnrollmentTrendsByGrade, DistrictCode == "1950" | DistrictCode == "5210")

#remove total enrollment
foo <- foo[!(foo$Grade=="Total Enrollment"),]

#remove the word Grade from beginning
foo$Grade <- substring(foo$Grade, 7)

#reformat foo Grade (it's written as 07 instead of 7)
foo$Grade[foo$Grade=="01"] <- "1"
foo$Grade[foo$Grade=="02"] <- "2"
foo$Grade[foo$Grade=="03"] <- "3"
foo$Grade[foo$Grade=="04"] <- "4"
foo$Grade[foo$Grade=="05"] <- "5"
foo$Grade[foo$Grade=="06"] <- "6"
foo$Grade[foo$Grade=="07"] <- "7"
foo$Grade[foo$Grade=="08"] <- "8"
foo$Grade[foo$Grade=="09"] <- "9"
foo$Grade[foo$Grade=="PK"] <- "-1"
foo$Grade[foo$Grade=="KG"] <- "0"
foo$Grade[foo$Grade=="ed"] <- "99" #ungraded?

#label missing values as NA
foo[foo == "N"] <- NA
foo[foo == "*"] <- NA

#convert all columns to numeric
foo[] <- lapply(foo, function(x) as.numeric(as.character(x)))

#calculate total number of students in each grade 
foo2 <- group_by(foo, DistrictCode, Grade) %>%
  summarise(
    numofstudents = sum(Count)
  )

#calculate total num of students for county 13 and 3
x1950 <- sum(foo2$numofstudents[foo2$DistrictCode==1950])
x5210 <- sum(foo2$numofstudents[foo2$DistrictCode==5210])

#divide to get percent
foo2$percent <- 0
foo2$percent[1:15] <- foo2$numofstudents[1:15] / x1950
foo2$percent[16:30] <- foo2$numofstudents[16:30] / x5210

ggplot(foo2,aes(x=factor(Grade),y=percent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Grade", y = "Percent of students")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels=percent,limits=c(0,.1),breaks=seq(0,.1,.01))+
  scale_x_discrete(breaks=c("-1","0","1","2","3","4","5","6","7","8","9","10","11","12","99"),labels=c("PK", "KG","1","2","3","4","5","6","7","8","9","10","11","12","Ungraded"))+
  theme(legend.position = "bottom")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(text=element_text(family="Times"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"), name="District", breaks=c("1950","5210"), labels=c("1950 (good)", "5210 (bad)"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  guides(color=FALSE)

```

District 1950 (good) have more students in older grades (6-12), whereas District 5210 (bad) have more students in younger grades (KG-4).
\newpage

###Gender breakdown 

```{r, echo=FALSE, warning=FALSE,fig.width=10}
foo <- subset(EnrollmentTrendsByStudentGroup, DistrictCode == "1950" | DistrictCode == "5210")
foo <- subset(foo, StudentGroup == "Male" | StudentGroup == "Female")

#label missing values as NA
foo[foo == "N"] <- NA
foo[foo == "*"] <- NA

#convert all columns to numeric
foo$CountyCode <- as.numeric(as.character(foo$CountyCode))
foo$DistrictCode <- as.numeric(as.character(foo$DistrictCode))
foo$SchoolCode <- as.numeric(as.character(foo$SchoolCode))
foo$Percent <- as.numeric(as.character(foo$Percent))

#convert race group to numbers
foo$group <- 1 #Female = 1
foo$group[foo$StudentGroup=="Male"] <- 2

#convert number to decimal
foo$Percent <- foo$Percent / 100

#calculate total number of students in each grade 
foo2 <- group_by(foo, DistrictCode, group) %>%
  summarise(
    meanpercent = mean(Percent),
    sepercent=sd(Percent, na.rm = TRUE)/sqrt(length(Percent))
  )

limits <- aes(ymax = meanpercent + sepercent, ymin=meanpercent - sepercent)

ggplot(foo2,aes(x=factor(group),y=meanpercent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Student group", y = "Percent of students")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels=percent,limits=c(0,.6),breaks=seq(0,.6,.1))+
  scale_x_discrete(breaks=c("1","2"),labels=c("Female", "Male"))+
  theme(legend.position = "bottom")+
  theme(text=element_text(family="Times"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"), name="District", breaks=c("1950","5210"), labels=c("1950 (good)", "5210 (bad)"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  geom_errorbar(limits, width=0.25, color="black",position=position_dodge(width=0.9))+
  guides(color=FALSE)
```

The two districts have same percentage of students that are female and male.
\newpage

###Ethnicity breakdown 

```{r, echo=FALSE, warning=FALSE, fig.width=10}
foo <- subset(EnrollmentByRacialEthnicGroup, DistrictCode == "1950" | DistrictCode == "5210")

#label missing values as NA
foo[foo == "N"] <- NA
foo[foo == "*"] <- NA

#convert all columns to numeric
foo$CountyCode <- as.numeric(as.character(foo$CountyCode))
foo$DistrictCode <- as.numeric(as.character(foo$DistrictCode))
foo$SchoolCode <- as.numeric(as.character(foo$SchoolCode))
foo$Percent <- as.numeric(as.character(foo$Percent))

#convert race group to numbers
foo$ethnic <- 1
foo$ethnic[foo$RacialAndEthnicGroup=="Asian"] <- 2
foo$ethnic[foo$RacialAndEthnicGroup=="Black or African American"] <- 3 
foo$ethnic[foo$RacialAndEthnicGroup=="Hispanic"] <- 4 
foo$ethnic[foo$RacialAndEthnicGroup=="Native Hawaiian or Pacific Islander"] <- 5 
foo$ethnic[foo$RacialAndEthnicGroup=="Two or More Races"] <- 6 
foo$ethnic[foo$RacialAndEthnicGroup=="White"] <- 7 

#convert number to decimal
foo$Percent <- foo$Percent / 100

#calculate total number of students in each grade 
foo2 <- group_by(foo, DistrictCode, ethnic) %>%
  summarise(
    meanpercent = mean(Percent),
    sepercent=sd(Percent, na.rm = TRUE)/sqrt(length(Percent))
  )

limits <- aes(ymax = meanpercent + sepercent, ymin=meanpercent - sepercent)

ggplot(foo2,aes(x=factor(ethnic),y=meanpercent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Ethnicity", y = "Percent of students")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels=percent,limits=c(0,.6),breaks=seq(0,.6,.1))+
  scale_x_discrete(breaks=c("1","2","3","4","5","6","7"),labels=c("Native American", "Asian","Black","Hispanic","Hawaiian/PacIslander","2+ Races","White"))+
  theme(legend.position = "bottom")+
  theme(text=element_text(family="Times"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"), name="District", breaks=c("1950","5210"), labels=c("1950 (good)", "5210 (bad)"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  geom_errorbar(limits, width=0.25, color="black",position=position_dodge(width=0.9))+
  guides(color=FALSE)
  
```

The ethnicity composition for the two districts are very different. District 5210 (bad) have less Asian, significantly more Black, significantly more Hispanic, less mixed race and significantly less White students. 
\newpage

###Student group breakdown 

```{r, echo=FALSE, warning=FALSE,fig.width=10}
foo <- subset(EnrollmentTrendsByStudentGroup, DistrictCode == "1950" | DistrictCode == "5210")
foo <- subset(foo, StudentGroup != "Male" & StudentGroup != "Female")

#label missing values as NA
foo[foo == "N"] <- NA
foo[foo == "*"] <- NA

#convert all columns to numeric
foo$CountyCode <- as.numeric(as.character(foo$CountyCode))
foo$DistrictCode <- as.numeric(as.character(foo$DistrictCode))
foo$SchoolCode <- as.numeric(as.character(foo$SchoolCode))
foo$Percent <- as.numeric(as.character(foo$Percent))

#convert race group to numbers
foo$group <- 1
foo$group[foo$StudentGroup=="English Learners"] <- 2
foo$group[foo$StudentGroup=="Homeless Students"] <- 3 
foo$group[foo$StudentGroup=="Migrant Students"] <- 4 
foo$group[foo$StudentGroup=="Military-Connected Students"] <- 5 
foo$group[foo$StudentGroup=="Students in Foster Care"] <- 6 
foo$group[foo$StudentGroup=="Students with Disabilities"] <- 7 

#convert number to decimal
foo$Percent <- foo$Percent / 100

#calculate total number of students in each grade 
foo2 <- group_by(foo, DistrictCode, group) %>%
  summarise(
    meanpercent = mean(Percent),
    sepercent=sd(Percent, na.rm = TRUE)/sqrt(length(Percent))
  )

limits <- aes(ymax = meanpercent + sepercent, ymin=meanpercent - sepercent)

ggplot(foo2,aes(x=factor(group),y=meanpercent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Student group", y = "Percent of students")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels=percent,limits=c(0,.9),breaks=seq(0,.9,.1))+
  scale_x_discrete(breaks=c("1","2","3","4","5","6","7"),labels=c("EcoDis", "EngLearners","Homeless","Migrant","Military","Foster Care","Disabilities"))+
  theme(legend.position = "bottom")+
  theme(text=element_text(family="Times"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"), name="District", breaks=c("1950","5210"), labels=c("1950 (good)", "5210 (bad)"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  geom_errorbar(limits, width=0.25, color="black",position=position_dodge(width=0.9))+
  guides(color=FALSE)
```

The student group composition for the two districts are very different. District 5210 (bad) have significantly more economically disadvantaged and significantly more English learners. The other student group categories are similar for the two districts. 

\newpage

###Languages spoken at home  
There are 15 language categories, but after looking at the percent of students that spoke the 15 languages it turns out that majority of students were either in the English or Spanish group.

```{r, echo=FALSE, warning=FALSE,fig.width=10}
foo <- subset(EnrollmentByHomeLanguage, DistrictCode == "1950" | DistrictCode == "5210")

#label missing values as NA
foo[foo == "N"] <- NA
foo[foo == "*"] <- NA

#convert all columns to numeric
foo$CountyCode <- as.numeric(as.character(foo$CountyCode))
foo$DistrictCode <- as.numeric(as.character(foo$DistrictCode))
foo$SchoolCode <- as.numeric(as.character(foo$SchoolCode))
foo$Percent <- as.numeric(as.character(foo$`%OfStudents`))

#convert group to numbers
foo$group <- 1 #english
foo$group[foo$HomeLanguage=="Other"] <- 2
foo$group[foo$HomeLanguage=="Spanish"] <- 3 
foo$group[foo$HomeLanguage=="Haitian"] <- 4 
foo$group[foo$HomeLanguage=="Creoles and pidgins, French-based"] <- 5 
foo$group[foo$HomeLanguage=="Urdu"] <- 6 
foo$group[foo$HomeLanguage=="Arabic"] <- 7 
foo$group[foo$HomeLanguage=="French"] <- 8 
foo$group[foo$HomeLanguage=="Twi"] <- 9 
foo$group[foo$HomeLanguage=="Creoles and pidgins"] <- 10 
foo$group[foo$HomeLanguage=="Bengali"] <- 11 
foo$group[foo$HomeLanguage=="Creoles and pidgins, English based"] <- 12 
foo$group[foo$HomeLanguage=="Pashto"] <- 13 
foo$group[foo$HomeLanguage=="Chinese"] <- 14 
foo$group[foo$HomeLanguage=="Polish"] <- 15 

#convert number to decimal
foo$Percent <- foo$Percent / 100

#calculate total number of students in each grade 
foo2 <- group_by(foo, DistrictCode, group) %>%
  summarise(
    meanpercent = mean(Percent),
    sepercent=sd(Percent, na.rm = TRUE)/sqrt(length(Percent))
  )

limits <- aes(ymax = meanpercent + sepercent, ymin=meanpercent - sepercent)

foo3 <- subset(foo2, group <4)

ggplot(foo3,aes(x=factor(group),y=meanpercent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Language", y = "Percent of students")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels=percent,limits=c(0,.9),breaks=seq(0,.9,.1))+
  scale_x_discrete(breaks=c("1","2","3"),labels=c("English", "Other","Spanish"))+
  theme(legend.position = "bottom")+
  theme(text=element_text(family="Times"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"), name="District", breaks=c("1950","5210"), labels=c("1950 (good)", "5210 (bad)"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  geom_errorbar(limits, width=0.25, color="black",position=position_dodge(width=0.9))+
  guides(color=FALSE)
```

District 5210 (bad) have less English speakers, and significantly more students who speak Spanish at home. 
\newpage

###Teacher absenteeism

```{r, echo=FALSE, warning=FALSE,fig.width=10}
foo <- subset(FacultyAttendance, District_Code == "1950" | District_Code == "5210")

#label missing values as NA
foo[foo == "N"] <- NA
foo[foo == "*"] <- NA

#convert all columns to numeric
foo$CountyCode <- as.numeric(as.character(foo$County_Code))
foo$DistrictCode <- as.numeric(as.character(foo$District_Code))
foo$SchoolCode <- as.numeric(as.character(foo$School_Code))
foo$Percent <- as.numeric(as.character(foo$PercentDaysPresent))

#convert number to decimal
foo$Percent <- foo$Percent / 100

#calculate total number of students in each grade 
foo2 <- group_by(foo, DistrictCode) %>%
  summarise(
    meanpercent = mean(Percent),
    sepercent=sd(Percent, na.rm = TRUE)/sqrt(length(Percent))
  )

limits <- aes(ymax = meanpercent + sepercent, ymin=meanpercent - sepercent)

ggplot(foo2,aes(x=factor(DistrictCode),y=meanpercent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "District", y = "Percent of days faculty were present")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels=percent)+
  theme(legend.position = "bottom")+
  theme(text=element_text(family="Times"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"), name="District", breaks=c("1950","5210"), labels=c("1950 (good)", "5210 (bad)"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  geom_errorbar(limits, width=0.25, color="black",position=position_dodge(width=0.9))+
  guides(color=FALSE)
```

The two districts have same percentage of teacher attendance. Teachers overall don't miss a lot of school.
\newpage

###Teacher and Admin One Year Retention

```{r, echo=FALSE, warning=FALSE,fig.width=10}
foo <- subset(TeachersAdminsOneYearRetention, District_Code == "1950" | District_Code == "5210")

#label missing values as NA
foo[foo == "N"] <- NA
foo[foo == "*"] <- NA

#convert all columns to numeric
foo$CountyCode <- as.numeric(as.character(foo$County_Code))
foo$DistrictCode <- as.numeric(as.character(foo$District_Code))
foo$Percent <- as.numeric(as.character(foo$RetentionPct_District))

#convert group to numbers
foo$group <- 1 #Teachers
foo$group[foo$`Teachers/Admins`=="Administrators"] <- 2

#convert number to decimal
foo$Percent <- foo$Percent / 100

ggplot(foo,aes(x=factor(group),y=Percent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "Teacher or Admin", y = "Percent of one year retention")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels=percent,limits=c(0,.9),breaks=seq(0,.9,.1))+
  scale_x_discrete(breaks=c("1","2"),labels=c("Teachers", "Administrators"))+
  theme(legend.position = "bottom")+
  theme(text=element_text(family="Times"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"), name="District", breaks=c("1950","5210"), labels=c("1950 (good)", "5210 (bad)"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  guides(color=FALSE)
```

Retention of teachers at one year is significantly less for District 1950 (good), which is surprising. The two districts have same percentage of administrator retention attendance.  
\newpage

###Student to Staff Ratio

```{r, echo=FALSE, warning=FALSE,fig.width=10}
foo <- subset(StudentToStaffRatios, DISTRICT_CODE == "1950" | DISTRICT_CODE == "5210")

#label missing values as NA
foo[foo == "N"] <- NA
foo[foo == "*"] <- NA

#remove last 2 character from column :1
foo$TeacherRatio <- substr(foo$TeacherRatio,1,nchar(foo$TeacherRatio)-2)
foo$AdministratorsRatio <- substr(foo$AdministratorsRatio,1,nchar(foo$AdministratorsRatio)-2)

#convert all columns to numeric
foo$CountyCode <- as.numeric(as.character(foo$COUNTY_CODE))
foo$DistrictCode <- as.numeric(as.character(foo$DISTRICT_CODE))
foo$SchoolCode <- as.numeric(as.character(foo$SCHOOL_CODE))
foo$TeacherRatio <- as.numeric(as.character(foo$TeacherRatio))
foo$AdministratorsRatio <- as.numeric(as.character(foo$AdministratorsRatio))

#calculate total number of students in each grade 
foo2 <- group_by(foo, DistrictCode) %>%
  summarise(
    meanTeacherPercent = mean(TeacherRatio),
    seTeacherPercent=sd(TeacherRatio, na.rm = TRUE)/sqrt(length(TeacherRatio)),
    meanAdminPercent = mean(AdministratorsRatio),
    seAdminPercent=sd(AdministratorsRatio, na.rm = TRUE)/sqrt(length(AdministratorsRatio))    
  )

#Teachers
foo3 <- foo2[,1:3]
  
limits <- aes(ymax = meanTeacherPercent + seTeacherPercent, ymin=meanTeacherPercent - seTeacherPercent)

ggplot(foo3,aes(x=factor(DistrictCode),y=meanTeacherPercent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  ggtitle("\n\nTeachers")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "District", y = "Number of students per teachers")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "none")+
  theme(text=element_text(family="Times"))+
  scale_y_continuous(limits=c(0,13),breaks=seq(0,13,1))+
  scale_x_discrete(breaks=c("1950","5210"),labels=c("1950 (good)", "5210 (bad)"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  geom_errorbar(limits, width=0.25, color="black",position=position_dodge(width=0.9))
```

```{r, echo=FALSE, warning=FALSE,fig.width=10}
#Admins
foo3 <- foo2[,c(1,4,5)]
  
limits <- aes(ymax = meanAdminPercent + seAdminPercent, ymin=meanAdminPercent - seAdminPercent)

ggplot(foo3,aes(x=factor(DistrictCode),y=meanAdminPercent,color=factor(DistrictCode),fill=factor(DistrictCode)))+
  geom_bar(stat="identity", position ="dodge")+
  ggtitle("\n\nAdministrators")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(x = "District", y = "Number of students per administrators")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(text=element_text(family="Times"))+
  scale_y_continuous(limits=c(0,400),breaks=seq(0,400,50))+
  scale_x_discrete(breaks=c("1950","5210"),labels=c("1950 (good)", "5210 (bad)"))+
  scale_fill_manual(values = c("#bebad9", "#3b6dae"))+
  scale_color_manual(values = c("#bebad9", "#3b6dae"))+
  geom_errorbar(limits, width=0.25, color="black",position=position_dodge(width=0.9))+
  theme(legend.position = "none")
```

The student:teacher ratio, and student:administrator ratio, is much higher for District 5210 (bad).
\newpage

##ALICE report:

In 2014, Mercer County had 39% of its household below the ALICE threshold, meaning they live in poverty (page 13).  

In 2014, Trenton had 75% of its household below the ALICE threshold (page 14). The high percentage of schools that has chronic absenteeism is likely related.  

\newpage

##Summary:

Comparing District 1950 (good) and District 5210 (bad), it looks like the district with higher chronic absenteeism have more economically disadvantaged students, more english learners, less Asian students, less White students, more Black students and more Hispanic students.  

District 5210 (bad) also tend to have more students in elementary school (esp grades 1-4) compared to other grades
